"""\nClaude Runner - Core implementation for invoking Claude CLI.\n\nThis module provides a consistent way to invoke Claude Code CLI in\nnon-interactive mode across all jib tasks. It passes the prompt via\nstdin (NOT --print mode, which creates a restricted session).\n\nKey features:\n- Consistent invocation pattern across all callers\n- Automatic timeout handling\n- Structured result with success/failure indication\n- Optional interactive mode for real-time output\n"""\n\nimport subprocess\nfrom dataclasses import dataclass\nfrom pathlib import Path\n\n\n@dataclass\nclass ClaudeResult:\n    """Result of a Claude CLI invocation.\n\n    Attributes:\n        success: True if Claude exited with code 0\n        returncode: The process return code\n        stdout: Standard output (empty string if not captured)\n        stderr: Standard error (empty string if not captured)\n        error: Human-readable error message if failed\n        timed_out: True if the process timed out\n    """\n\n    success: bool\n    returncode: int\n    stdout: str = ""\n    stderr: str = ""\n    error: str | None = None\n    timed_out: bool = False\n\n\ndef check_claude_cli() -> bool:\n    """Check if the claude CLI is available.\n\n    Returns:\n        True if claude CLI is installed and responds to --version\n    """\n    try:\n        result = subprocess.run(\n            ["claude", "--version"],\n            check=False,\n            capture_output=True,\n            text=True,\n            timeout=5,\n        )\n        return result.returncode == 0\n    except (subprocess.SubprocessError, FileNotFoundError):\n        return False\n\n\ndef run_claude(\n    prompt: str,\n    *,\n    timeout: int = 300,\n    cwd: str | Path | None = None,\n    capture_output: bool = True,\n    interactive: bool = False,\n) -> ClaudeResult:\n    """Run Claude in non-interactive mode with the given prompt.\n\n    This function passes the prompt via stdin, which gives Claude full\n    access to tools and filesystem. DO NOT use --print mode, which\n    creates a restricted session.\n\n    Args:\n        prompt: The prompt to send to Claude\n        timeout: Maximum time in seconds to wait (default: 300)\n        cwd: Working directory for Claude (default: current directory)\n        capture_output: Whether to capture stdout/stderr (default: True)\n            Set to False for interactive mode or when streaming output\n        interactive: If True, don't capture output (real-time display)\n            This is mutually exclusive with capture_output\n\n    Returns:\n        ClaudeResult with success status and output\n\n    Examples:\n        # Basic usage\n        result = run_claude("Analyze this code and suggest fixes")\n        if result.success:\n            print(result.stdout)\n\n        # With timeout and working directory\n        result = run_claude(\n            prompt="Fix the lint errors in this file",\n            timeout=600,\n            cwd="/path/to/repo",\n        )\n\n        # Interactive mode (output streams to console)\n        result = run_claude(\n            prompt="Help me debug this issue",\n            interactive=True,\n        )\n    """\n    # Validate arguments\n    if interactive:\n        capture_output = False\n\n    # Convert cwd to string if Path\n    cwd_str = str(cwd) if cwd else None\n\n    try:\n        # Run Claude via stdin (NOT --print which creates restricted session)\n        # --dangerously-skip-permissions allows tool use without interactive prompts\n        result = subprocess.run(\n            ["claude", "--dangerously-skip-permissions"],\n            check=False,\n            input=prompt,\n            text=True,\n            capture_output=capture_output,\n            timeout=timeout,\n            cwd=cwd_str,\n        )\n\n        if result.returncode == 0:\n            return ClaudeResult(\n                success=True,\n                returncode=0,\n                stdout=result.stdout if capture_output else "",\n                stderr=result.stderr if capture_output else "",\n            )\n        else:\n            error_msg = f"Claude exited with code {result.returncode}"\n            if capture_output and result.stderr:\n                error_msg += f": {result.stderr[:200]}"\n\n            return ClaudeResult(\n                success=False,\n                returncode=result.returncode,\n                stdout=result.stdout if capture_output else "",\n                stderr=result.stderr if capture_output else "",\n                error=error_msg,\n            )\n\n    except subprocess.TimeoutExpired:\n        return ClaudeResult(\n            success=False,\n            returncode=-1,\n            error=f"Claude timed out after {timeout} seconds",\n            timed_out=True,\n        )\n\n    except FileNotFoundError:\n        return ClaudeResult(\n            success=False,\n            returncode=-1,\n            error="Claude CLI not found - is it installed?",\n        )\n\n    except Exception as e:\n        return ClaudeResult(\n            success=False,\n            returncode=-1,\n            error=f"Error invoking Claude: {e}",\n        )\n