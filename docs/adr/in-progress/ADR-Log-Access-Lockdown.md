# ADR: Log Access Lockdown via Gateway Sidecar

**Driver:** James Wiesebron
**Approver:** TBD
**Contributors:** James Wiesebron
**Informed:** Engineering teams
**Proposed:** January 2026
**Status:** Proposed

## Table of Contents

- [Industry Standards Reference](#industry-standards-reference)
- [Context](#context)
- [Problem Statement](#problem-statement)
- [Decision](#decision)
- [High-Level Design](#high-level-design)
- [Security Analysis](#security-analysis)
- [Consequences](#consequences)
- [Alternatives Considered](#alternatives-considered)
- [Implementation Plan](#implementation-plan)

## Industry Standards Reference

This ADR extends the security principles established in [ADR-Internet-Tool-Access-Lockdown](./ADR-Internet-Tool-Access-Lockdown.md) and [ADR-Git-Isolation-Architecture](../implemented/ADR-Git-Isolation-Architecture.md), applying the same OWASP Agentic Application Security framework to log access:

| OWASP Risk | Description | Mitigation in This ADR |
|------------|-------------|------------------------|
| **ASI01** - Agentic Excessive Authority | Agents granted overly broad permissions | Agents can only read their own logs via gateway API |
| **ASI02** - Tool Misuse & Exploitation | Agents misusing available tools | Log search scoped by container/task ID; no cross-agent access |
| **ASI03** - Identity & Privilege Abuse | Credential theft or misuse | Logs not mounted in container; gateway validates all access |
| **ASI06** - Memory/Context Poisoning | Corruption of agent memory/config | Logs are read-only from container perspective |
| **ASI10** - Rogue Agents | Agent operating outside intended behavior | Infrastructure controls prevent unauthorized log access |

**Reference:** [OWASP Top 10 for Agentic Applications](https://genai.owasp.org/)

## Context

### Background

The james-in-a-box system stores logs in several locations accessible from the host filesystem:

| Path | Content | Current Access |
|------|---------|----------------|
| `~/.jib-sharing/container-logs/` | Container stdout/stderr (persistent) | Direct filesystem read |
| `~/.jib-sharing/logs/` | Claude output streams (real-time) | Direct filesystem read |
| `/var/log/jib/model_output/` | Full Claude responses (large files) | Direct filesystem read |

Currently, log access has **no gateway enforcement**:
- The `jib-logs` utility reads logs directly without authentication
- Container log persistence (`container_logging.py`) writes to shared directories
- Any process with filesystem access can read any agent's logs

This creates security and privacy concerns:
1. **Cross-agent information leakage**: One agent could read another agent's logs
2. **Sensitive data exposure**: Logs may contain API responses, internal data, or error details
3. **No audit trail**: Cannot determine who accessed which logs and when
4. **Inconsistent with git isolation model**: Git operations go through gateway, but logs don't

### Current Logging Architecture

The existing [ADR-Standardized-Logging-Interface](./ADR-Standardized-Logging-Interface.md) defines the **format** and **generation** of logs, but not **access control**. Logs are:

1. Generated by various components using `jib_logging` library
2. Written to files in `~/.jib-sharing/` directories
3. Indexed by `container_logging.py` for correlation (task_id → container_id)
4. Read via `jib-logs` CLI utility or direct file access

**Gap:** Access control and auditing are missing from the log lifecycle.

### Scope

**In Scope:**
- Log access control via gateway sidecar
- Read-only log APIs for containers
- Log search/retrieval policies
- Audit logging for log access
- Container filesystem isolation for logs

**Out of Scope:**
- Log generation changes (already covered by ADR-Standardized-Logging-Interface)
- Log format changes (already standardized)
- Log retention policies (separate concern)
- Real-time log streaming (future enhancement)

## Problem Statement

**Logs should follow the same security model as git operations: containers cannot access logs directly, and all access goes through the gateway with policy enforcement and audit logging.**

Specific requirements:

1. **Isolation**: Containers cannot mount or read log directories directly
2. **Scoped access**: Agents can only read their own logs (by container_id or task_id)
3. **Audit trail**: All log access is recorded with timestamp, accessor, and scope
4. **Gateway enforcement**: Policy violations result in HTTP 403, not silent failures
5. **Consistency**: Same authentication/authorization pattern as git operations

## Decision

**Extend the gateway sidecar architecture to provide log access control, mirroring the git isolation model.**

### Core Principles

1. **Filesystem isolation**: `~/.jib-sharing/` is not mounted in the jib container
2. **Gateway as single access point**: All log reads go through `/api/v1/logs/*` endpoints
3. **Container-scoped access**: Default policy allows reading only own logs
4. **Audit everything**: Every log access is recorded in gateway audit logs
5. **Fail closed**: Missing authentication or policy violation returns 403

## High-Level Design

### Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     Container Filesystem View                                 │
│                                                                               │
│  /home/jib/repos/my-repo/    ← Worktree (existing, via git isolation)        │
│  /home/jib/context-sync/     ← Read-only context                             │
│  /home/jib/beads/            ← Task tracking                                 │
│                                                                               │
│  ~/.jib-sharing/             ← NOT MOUNTED (no logs visible)                 │
│  /var/log/jib/               ← NOT MOUNTED (no logs visible)                 │
│                                                                               │
│  Container CANNOT directly read any logs                                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ HTTP API calls
                                    │ (authenticated with Bearer token)
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Gateway Sidecar (Trusted)                              │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    Log Access Endpoints                               │    │
│  │                                                                       │    │
│  │  GET  /api/v1/logs/list           - List recent logs                 │    │
│  │  GET  /api/v1/logs/task/<id>      - Get logs for task                │    │
│  │  GET  /api/v1/logs/container/<id> - Get logs by container ID         │    │
│  │  GET  /api/v1/logs/search         - Search with pattern (scoped)     │    │
│  │  GET  /api/v1/logs/model/<id>     - Get model output for task        │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                          │
│                                    ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    Policy Enforcement                                 │    │
│  │                                                                       │    │
│  │  - Validate authentication (Bearer token)                            │    │
│  │  - Extract requester's container_id/task_id from context             │    │
│  │  - Check: requested logs belong to requester OR admin role           │    │
│  │  - Return 403 if policy violated                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                          │
│                                    ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    Log Storage (Host Filesystem)                      │    │
│  │                                                                       │    │
│  │  ~/.jib-sharing/container-logs/  - Container stdout/stderr           │    │
│  │  ~/.jib-sharing/logs/            - Real-time Claude output           │    │
│  │  /var/log/jib/model_output/      - Full model responses              │    │
│  │                                                                       │    │
│  │  Gateway has read access; containers do NOT                          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Component Summary

| Component | Purpose | Implementation |
|-----------|---------|----------------|
| Log API endpoints | Controlled interface for log access | Flask routes in gateway.py |
| Log policy engine | Validate access against ownership | Extension of policy.py |
| Log client | Convenience methods for API calls | Python module for containers |
| Audit logger | Record all log access | Existing gateway audit system |
| Container mount changes | Remove log paths from container | Docker Compose changes |

### Key Security Properties

1. **Container cannot read logs** - `~/.jib-sharing/` is not mounted
2. **Scoped access by default** - Agents can only read their own logs
3. **All access is auditable** - Gateway logs every log access request
4. **Authentication required** - Same Bearer token as git operations
5. **Policy violations logged** - Denied access attempts are recorded

### Gateway Log API

#### Endpoints

| Endpoint | Method | Parameters | Response | Policy |
|----------|--------|------------|----------|--------|
| `/api/v1/logs/list` | GET | `?limit=N&offset=M` | List of log entries | Own logs only |
| `/api/v1/logs/task/<task_id>` | GET | - | Log content for task | Task must belong to requester |
| `/api/v1/logs/container/<container_id>` | GET | `?lines=N` | Log content | Container must be self |
| `/api/v1/logs/search` | GET | `?pattern=<regex>&scope=self` | Matching log entries | Search limited to own logs |
| `/api/v1/logs/model/<task_id>` | GET | - | Full model output | Task must belong to requester |

#### Request/Response Format

**Request (authenticated):**
```http
GET /api/v1/logs/task/task-20260128-123456 HTTP/1.1
Authorization: Bearer <gateway-secret>
X-Container-ID: jib-abc123
X-Task-ID: task-20260128-123456
```

**Response (success):**
```json
{
  "task_id": "task-20260128-123456",
  "container_id": "jib-abc123",
  "log_file": "/path/to/log",
  "content": "... log lines ...",
  "lines": 500,
  "truncated": false
}
```

**Response (policy violation):**
```json
{
  "error": "access_denied",
  "message": "Cannot access logs for task task-other-123",
  "reason": "Task does not belong to requesting container"
}
```

### Log Policy Engine

Extend the existing policy engine with log-specific rules:

```python
@dataclass
class LogAccessPolicy:
    """Policy for log access control."""

    def check_task_access(
        self,
        requester_container_id: str,
        requester_task_id: str | None,
        target_task_id: str,
    ) -> PolicyResult:
        """Check if requester can access logs for target task."""
        # Look up task's container from index
        owner_container = self.log_index.get_container_for_task(target_task_id)

        if owner_container is None:
            return PolicyResult(
                allowed=False,
                reason="Task not found in log index",
            )

        if owner_container == requester_container_id:
            return PolicyResult(allowed=True, reason="Owner access")

        if requester_task_id == target_task_id:
            return PolicyResult(allowed=True, reason="Task identity match")

        return PolicyResult(
            allowed=False,
            reason="Cross-container log access denied",
            details={
                "requester": requester_container_id,
                "owner": owner_container,
                "target_task": target_task_id,
            },
        )
```

### Audit Log Format

Every log access produces an audit entry:

```json
{
  "timestamp": "2026-01-28T14:32:01.234Z",
  "event_type": "log_access",
  "operation": "read_task_logs",
  "source_ip": "172.18.0.2",
  "source_container": "jib-abc123",
  "auth_valid": true,
  "request": {
    "target_task_id": "task-20260128-123456",
    "endpoint": "/api/v1/logs/task/task-20260128-123456"
  },
  "policy_result": {
    "allowed": true,
    "reason": "Owner access"
  },
  "response": {
    "status": 200,
    "lines_returned": 500,
    "duration_ms": 45
  }
}
```

### Container Log Client

Provide a Python client for containers to access logs via the gateway:

```python
# shared/jib_logging/log_client.py

from jib_logging.log_client import LogClient

client = LogClient()  # Uses environment for gateway URL and secret

# Get own logs
logs = client.get_task_logs("task-20260128-123456")
print(logs.content)

# Search own logs
results = client.search("error", limit=10)
for entry in results:
    print(f"{entry.timestamp}: {entry.message}")

# Get model output
model_output = client.get_model_output("task-20260128-123456")
print(f"Tokens used: {model_output.input_tokens + model_output.output_tokens}")
```

### jib-logs CLI Migration

The existing `jib-logs` utility should route through the gateway when run from within a container:

```bash
# Current behavior (direct filesystem access - INSECURE):
jib-logs --search "error"
# Reads from ~/.jib-sharing/ directly

# New behavior (gateway-mediated):
jib-logs --search "error"
# Calls GET /api/v1/logs/search?pattern=error
# Returns only logs for current container's tasks
```

For host-side usage (admin/debugging), the utility can continue with direct access, but should emit an audit log.

## Security Analysis

### Threat Model

| Threat | Mitigation | Residual Risk |
|--------|------------|---------------|
| Agent reads other agent's logs | Filesystem isolation + policy enforcement | VERY LOW - No mount = no access |
| Agent discovers task IDs to probe | Policy checks ownership, not just task existence | LOW - Probe attempts logged |
| Sensitive data in logs | Logs are already written; this ADR controls read access | MEDIUM - Data at rest unchanged |
| Log injection attacks | Logs are read-only via gateway | VERY LOW - No write operations |
| Bypass via docker exec | Gateway still controls container mounts | LOW - Requires host access |
| Audit log tampering | Audit logs in gateway, not container | LOW - Container can't modify |

### What This Does NOT Address

1. **Sensitive data in logs**: This ADR controls access, not content. Logs may still contain sensitive data.
2. **Log encryption at rest**: Logs are stored unencrypted on host. Encryption is a separate concern.
3. **Cross-agent data in logs**: If logs contain information about other agents, that's a logging practice issue.
4. **Real-time log streaming**: This ADR covers pull-based access, not WebSocket streaming.

### Defense in Depth Summary

```
Layer 1: Behavioral (CLAUDE.md instructions)
    ↓ Agent told not to access other logs
Layer 2: Filesystem Isolation (this ADR)
    ↓ ~/.jib-sharing/ not mounted = cannot access even if instructed
Layer 3: Gateway Policy Enforcement
    ↓ API validates ownership before returning logs
Layer 4: Audit Logging
    ↓ All access attempts recorded
Layer 5: Network Isolation
    ↓ Container can only reach gateway
```

## Consequences

### Positive

- **Consistent security model**: Logs follow same pattern as git (gateway-mediated)
- **Audit trail**: All log access is recorded with context
- **Cross-agent isolation**: Agents cannot read each other's logs
- **Policy flexibility**: Can add new policies (role-based, time-limited) later
- **No code changes in logging**: Log generation unchanged; only access controlled

### Negative

- **Latency**: Log reads go through HTTP API instead of filesystem
- **Complexity**: Additional gateway endpoints to maintain
- **Breaking change**: Tools that read logs directly will need updates
- **Debugging friction**: Developers may need admin access for cross-container debugging

### Trade-offs

| Aspect | Direct Filesystem | Gateway-Mediated |
|--------|-------------------|------------------|
| Access speed | Fast (filesystem) | HTTP overhead (~10-50ms) |
| Security | None | Policy-enforced |
| Auditability | None | Full audit trail |
| Cross-agent access | Unrestricted | Denied by default |
| Debugging | Easy | Requires gateway access |

## Alternatives Considered

### Alternative 1: Unix File Permissions

**Approach:** Set file permissions so each container's user can only read own logs

**Pros:**
- Simple, uses existing Unix security model
- No gateway changes needed

**Cons:**
- Requires unique UID per container (complex orchestration)
- No audit trail
- Permissions can be complex to manage across volumes
- Doesn't work well with Docker shared volumes

**Rejected:** Too complex to implement reliably in containerized environment

### Alternative 2: Encrypted Logs Per-Container

**Approach:** Encrypt each container's logs with a unique key

**Pros:**
- Strong isolation via cryptography
- Works even with shared filesystem

**Cons:**
- Key management complexity
- Performance overhead for encryption/decryption
- Doesn't solve cross-agent probing
- Adds significant implementation complexity

**Rejected:** Overkill for the threat model; gateway isolation is simpler

### Alternative 3: Separate Log Volumes Per Container

**Approach:** Mount a unique log volume for each container

**Pros:**
- Natural filesystem isolation
- No gateway changes needed

**Cons:**
- Volume proliferation (one per container)
- No central log search/aggregation
- Storage management complexity
- Breaks log correlation features

**Rejected:** Fragments the logging architecture; loses correlation benefits

## Implementation Plan

### Phase 1: Gateway Log Endpoints

1. Add log access endpoints to `gateway.py`
2. Implement log policy engine in `policy.py`
3. Add audit logging for log access
4. Unit tests for policy enforcement

### Phase 2: Container Isolation

1. Remove `~/.jib-sharing/` from container mounts (Docker Compose)
2. Update `jib-logs` utility to use gateway API when in container
3. Create `LogClient` Python module for programmatic access
4. Integration tests for end-to-end log access

### Phase 3: Migration

1. Update CLAUDE.md documentation
2. Update any scripts that read logs directly
3. Deprecation warnings for direct filesystem access from containers
4. Monitor audit logs for unexpected access patterns

### Phase 4: Enhancements (Future)

1. Real-time log streaming via WebSocket
2. Role-based access for admin/debugging scenarios
3. Log retention policies via gateway
4. Log search indexing for better performance

## Related ADRs

| ADR | Relationship |
|-----|--------------|
| [ADR-Git-Isolation-Architecture](../implemented/ADR-Git-Isolation-Architecture.md) | Model for gateway-based isolation |
| [ADR-Internet-Tool-Access-Lockdown](./ADR-Internet-Tool-Access-Lockdown.md) | Parent security framework |
| [ADR-Standardized-Logging-Interface](./ADR-Standardized-Logging-Interface.md) | Defines log format and generation |
| [ADR-Autonomous-Software-Engineer](./ADR-Autonomous-Software-Engineer.md) | Parent ADR defining security requirements |

---

**Last Updated:** 2026-01-28
**Next Review:** 2026-02-28 (Monthly)
**Status:** Proposed
