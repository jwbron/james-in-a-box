# Git Worktree Security Pentest Report

**Date**: 2026-02-01
**Tester**: jib (autonomous agent)
**Environment**: jib container with gateway-managed worktree architecture
**Result**: All security controls passed

## Executive Summary

The gateway-managed worktree architecture successfully isolates git metadata from the container. The `.git` directory is shadowed by a devtmpfs mount pointing to `/dev/null`, preventing all direct access to git configuration, credentials, and objects. All git operations must route through the gateway sidecar.

## Architecture Overview

```
Container                          Gateway Sidecar
┌──────────────────────┐          ┌──────────────────────┐
│ ~/repos/repo/        │          │ Git metadata         │
│   .git → /dev/null   │  ──────► │ Credentials          │
│   (working files)    │  Policy  │ Full .git directory  │
│                      │  Layer   │                      │
│ /usr/bin/git ────────┼──────────┤                      │
│   → wrapper script   │          │                      │
└──────────────────────┘          └──────────────────────┘
```

## Test Environment

| Property | Value |
|----------|-------|
| Repo Path | `/home/jib/repos/eng-ai-support` |
| Current Branch | `jib/jib-20260201-151651-1851969/work` |
| Worktree Type | Isolated jib worktree |
| `.git` Mount | `devtmpfs[/null]` (read-only) |

## Security Controls Tested

### 1. `.git` Directory Protection

```bash
$ stat /home/jib/repos/eng-ai-support/.git
  File: /home/jib/repos/eng-ai-support/.git
  Size: 0         Device type: 1,3  (character special)
  Access: (0666/crw-rw-rw-)

$ file /home/jib/repos/eng-ai-support/.git
character special (1/3)

$ findmnt --target /home/jib/repos/eng-ai-support/.git
TARGET                              SOURCE          FSTYPE   OPTIONS
/home/jib/repos/eng-ai-support/.git devtmpfs[/null] devtmpfs ro,nosuid,...
```

| Test | Result |
|------|--------|
| `.git` type | Character special device (1,3) = `/dev/null` |
| `.git` mount | devtmpfs, read-only |
| Read `.git` contents | Returns nothing (it's `/dev/null`) |
| `git config --local` | Fails - "not a git repository" |

**Conclusion**: Git metadata is completely inaccessible from the container.

### 2. Worktree Isolation

```bash
$ git worktree list
/home/jib/repos/eng-ai-support                                       e498c24 [main]
/home/jib/.jib-worktrees/jib-20260201-151651-1851969/eng-ai-support  e498c24 [jib/...]

$ ls ~/.jib-worktrees/
ls: cannot access '/home/jib/.jib-worktrees/': No such file or directory
```

| Test | Result |
|------|--------|
| Worktree directory exists | No - path doesn't exist in container |
| Checkout main branch | BLOCKED - "already used by worktree" |
| Access other worktrees | Not possible - directory doesn't exist |

**Conclusion**: Worktrees are listed by the gateway but don't exist in the container filesystem.

### 3. Branch Protection

| Test | Result | Error Message |
|------|--------|---------------|
| `git checkout main` | BLOCKED | "already used by worktree at '/home/jib/repos/eng-ai-support'" |
| `git checkout -b new origin/main` | ALLOWED | Can create new branches |
| `git push origin HEAD:main` | BLOCKED | "Branch 'main' is protected" |
| `git push` to jib-owned branch | ALLOWED | Works correctly |

**Conclusion**: Cannot escape to main branch or push to protected branches.

### 4. Real Binary Bypass Attempts

```bash
$ /opt/.jib-internal/git -C ~/repos/eng-ai-support status
fatal: not a git repository (or any parent up to mount point /home/jib/repos)
```

| Test | Result |
|------|--------|
| Real git binary location | `/opt/.jib-internal/git` |
| Real git can see repo | No - `.git` is `/dev/null` |
| Real git can fetch | No - no credentials |

**Conclusion**: Even bypassing the wrapper script, the real git binary cannot function because there's no git metadata.

### 5. Binary Wrapper Security

```bash
$ ls -la /usr/bin/git /usr/bin/gh
/usr/bin/git -> /opt/jib-runtime/jib-container/scripts/git
/usr/bin/gh  -> /opt/jib-runtime/jib-container/scripts/gh
```

The wrapper script:
1. Intercepts all git commands
2. Routes operations through the gateway API
3. Validates operations against an allowlist
4. Blocks dangerous flags

### 6. Git Operation Allowlist

| Category | Operations |
|----------|------------|
| Allowed | add, blame, branch, checkout, cherry-pick, clean, commit, config, describe, diff, fetch, log, ls-files, ls-remote, ls-tree, merge, mv, push, rebase, reflog, remote (read), reset, restore, rev-parse, rm, show, stash, status, switch, tag, worktree |
| Blocked | clone, credential, submodule |

### 7. Flag Injection Prevention

| Test | Result |
|------|--------|
| `git log --exec="cat /etc/passwd"` | BLOCKED - "Flag '--exec=...' is not allowed" |
| `git config --show-origin` | Works (read-only, no sensitive data) |

**Conclusion**: Dangerous flags are blocked per-operation.

### 8. Remote Manipulation

| Test | Result | Error Message |
|------|--------|---------------|
| `git remote add test <url>` | BLOCKED | "Git remote URLs are managed by the gateway" |
| `git remote set-url origin <url>` | BLOCKED | Same |
| `git remote -v` (read) | ALLOWED | Shows configured remotes |

**Conclusion**: Remote configuration is immutable from the container.

### 9. Destructive Operations

| Test | Result | Notes |
|------|--------|-------|
| `git reset --hard` | ALLOWED | Only affects local worktree |
| `git push --force` to own branch | ALLOWED | Policy permits on jib-owned branches |
| `git push --force` to main | BLOCKED | Protected branch |

**Conclusion**: Destructive operations are allowed on own branches but protected branches are safe.

## Security Properties Verified

1. **Git Metadata Isolation**: `.git` is `/dev/null`, no metadata accessible
2. **Worktree Confinement**: Cannot access or switch to other worktrees
3. **Branch Protection**: Cannot checkout or push to main/master
4. **Operation Allowlist**: Only safe git operations permitted
5. **Flag Filtering**: Dangerous flags blocked per-operation
6. **Remote Immutability**: Cannot add or modify remotes
7. **Credential Isolation**: No credentials in container, all auth via gateway

## Defense in Depth

| Layer | Protection |
|-------|------------|
| **Filesystem** | `.git` mounted as `/dev/null` via devtmpfs |
| **Binary** | git/gh are wrappers routing through gateway |
| **Gateway** | Validates operations, flags, and paths |
| **Policy** | Branch ownership, operation allowlists |
| **Credentials** | Held by gateway, never exposed to container |

## Conclusion

The gateway-managed worktree architecture provides robust security isolation. Even with full shell access, an attacker cannot:

- Access git credentials or tokens
- Read git configuration or objects
- Escape to other worktrees or branches
- Execute arbitrary commands via git flags
- Modify remote URLs to exfiltrate data
- Push to protected branches

The architecture successfully separates the working directory (accessible) from git metadata (isolated in gateway).

---

Authored-by: jib
