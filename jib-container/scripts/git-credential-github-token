#!/bin/bash
#
# Git credential helper that provides GitHub tokens for HTTPS authentication.
#
# NOTE: In the normal jib architecture, git operations are routed through the
# gateway sidecar which handles token management. This credential helper is
# a fallback for direct git operations.
#
# Token Sources (in priority order):
#   1. ~/sharing/.github-token file (if present)
#   2. GITHUB_TOKEN environment variable (set at container start)
#   3. GITHUB_READONLY_TOKEN for repos outside the primary App's scope
#
# Multi-token support:
#   The GitHub App is typically installed on one owner (e.g., jwbron/james-in-a-box).
#   For repos under other owners, we need GITHUB_READONLY_TOKEN.
#   The script reads the repo path and selects the appropriate token.
#
# Installation (done automatically by entrypoint):
#   git config --global credential.helper /path/to/git-credential-github-token
#   git config --global credential.https://github.com.helper '!/path/to/git-credential-github-token'
#
# How it works:
#   1. Git calls this script with "get" when authentication is needed
#   2. Script checks if the host is github.com
#   3. Reads repo path to determine which token to use
#   4. Returns username=x-access-token and password=$TOKEN
#   5. Git uses these credentials for the operation
#

# Only respond to "get" requests
if [ "$1" != "get" ]; then
    exit 0
fi

# Read the input from git (protocol, host, path, etc.)
host=""
path=""
while IFS='=' read -r key value; do
    case "$key" in
        host)
            host="$value"
            ;;
        path)
            path="$value"
            ;;
    esac
done

# Only provide credentials for github.com
if [[ "$host" != "github.com" ]]; then
    exit 0
fi

# Extract owner from path (e.g., "/owner/repo.git" -> "owner")
# Path format: /owner/repo.git or owner/repo.git
owner=""
if [[ -n "$path" ]]; then
    # Remove leading slash if present
    path="${path#/}"
    # Extract owner (everything before first /)
    owner="${path%%/*}"
fi

# Token file location (legacy - now managed by gateway sidecar in-memory)
TOKEN_FILE="${HOME}/sharing/.github-token"

# Determine which token to use based on repo owner
# For repos under external orgs (not matching primary owner), prefer GITHUB_READONLY_TOKEN
# Set GITHUB_PRIMARY_OWNER env var to define which org uses the main token
USE_READONLY=false
PRIMARY_OWNER="${GITHUB_PRIMARY_OWNER:-}"
if [[ -n "$owner" && -n "$PRIMARY_OWNER" && "$owner" != "$PRIMARY_OWNER" ]]; then
    USE_READONLY=true
fi

# Get token - prefer file (refreshed) over env var (potentially stale)
TOKEN=""

# For external repos, try GITHUB_READONLY_TOKEN first
if [[ "$USE_READONLY" == "true" && -n "${GITHUB_READONLY_TOKEN:-}" ]]; then
    TOKEN="$GITHUB_READONLY_TOKEN"
fi

# If no readonly token, try the standard token sources
if [ -z "$TOKEN" ]; then
    # Try to read from token file first
    if [ -f "$TOKEN_FILE" ]; then
        # Extract token from JSON file using python (available in container)
        # Falls back gracefully if file is invalid
        TOKEN=$(python3 -c "
import json
import sys
try:
    with open('$TOKEN_FILE') as f:
        data = json.load(f)
    print(data.get('token', ''))
except:
    pass
" 2>/dev/null)
    fi
fi

# Fall back to environment variable if file token not available
if [ -z "$TOKEN" ]; then
    TOKEN="$GITHUB_TOKEN"
fi

# Check if we have a token from any source
if [ -z "$TOKEN" ]; then
    echo "error: No GitHub token available" >&2
    echo "error: Neither ~/sharing/.github-token nor GITHUB_TOKEN is set" >&2
    if [[ "$USE_READONLY" == "true" ]]; then
        echo "error: For repo $owner/$path, GITHUB_READONLY_TOKEN is also not set" >&2
    fi
    exit 1
fi

# Output credentials in git credential format
# x-access-token is the special username for GitHub App tokens
echo "protocol=https"
echo "host=github.com"
echo "username=x-access-token"
echo "password=$TOKEN"
