#!/bin/bash
#
# Git credential helper that provides GitHub tokens for HTTPS authentication.
#
# Token Sources (in priority order):
#   1. ~/sharing/.github-token file (refreshed by github-token-refresher service)
#   2. GITHUB_TOKEN environment variable (set at container start)
#
# This allows git push over HTTPS without embedding tokens in remote URLs.
# The github-token-refresher service on the host generates fresh tokens every
# 45 minutes and writes them to the shared file, ensuring long-running
# containers always have valid tokens.
#
# Installation (done automatically by entrypoint):
#   git config --global credential.helper /path/to/git-credential-github-token
#   git config --global credential.https://github.com.helper '!/path/to/git-credential-github-token'
#
# How it works:
#   1. Git calls this script with "get" when authentication is needed
#   2. Script checks if the host is github.com
#   3. Reads token from file (preferred) or env var (fallback)
#   4. Returns username=x-access-token and password=$TOKEN
#   5. Git uses these credentials for the operation
#

# Only respond to "get" requests
if [ "$1" != "get" ]; then
    exit 0
fi

# Read the input from git (protocol, host, path, etc.)
host=""
while IFS='=' read -r key value; do
    case "$key" in
        host)
            host="$value"
            ;;
    esac
done

# Only provide credentials for github.com
if [[ "$host" != "github.com" ]]; then
    exit 0
fi

# Token file location (written by github-token-refresher on host)
TOKEN_FILE="${HOME}/sharing/.github-token"

# Get token - prefer file (refreshed) over env var (potentially stale)
TOKEN=""

# Try to read from token file first
if [ -f "$TOKEN_FILE" ]; then
    # Extract token from JSON file using python (available in container)
    # Falls back gracefully if file is invalid
    TOKEN=$(python3 -c "
import json
import sys
try:
    with open('$TOKEN_FILE') as f:
        data = json.load(f)
    print(data.get('token', ''))
except:
    pass
" 2>/dev/null)

    if [ -n "$TOKEN" ]; then
        # Token file is valid, use it
        :
    fi
fi

# Fall back to environment variable if file token not available
if [ -z "$TOKEN" ]; then
    TOKEN="$GITHUB_TOKEN"
fi

# Check if we have a token from any source
if [ -z "$TOKEN" ]; then
    echo "error: No GitHub token available" >&2
    echo "error: Neither ~/sharing/.github-token nor GITHUB_TOKEN is set" >&2
    exit 1
fi

# Output credentials in git credential format
# x-access-token is the special username for GitHub App tokens
echo "protocol=https"
echo "host=github.com"
echo "username=x-access-token"
echo "password=$TOKEN"
