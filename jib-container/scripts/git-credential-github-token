#!/bin/bash
#
# Git credential helper that uses GITHUB_TOKEN environment variable
#
# This allows git push over HTTPS without embedding tokens in remote URLs.
# The token is passed securely via the GITHUB_TOKEN environment variable
# which is set by the jib launcher from GitHub App credentials.
#
# Installation (done automatically by docker-setup.py):
#   git config --global credential.helper /path/to/git-credential-github-token
#   git config --global credential.https://github.com.helper '!/path/to/git-credential-github-token'
#
# How it works:
#   1. Git calls this script with "get" when authentication is needed
#   2. Script checks if the host is github.com
#   3. Returns username=x-access-token and password=$GITHUB_TOKEN
#   4. Git uses these credentials for the operation
#

# Only respond to "get" requests
if [ "$1" != "get" ]; then
    exit 0
fi

# Read the input from git (protocol, host, path, etc.)
host=""
while IFS='=' read -r key value; do
    case "$key" in
        host)
            host="$value"
            ;;
    esac
done

# Only provide credentials for github.com
if [[ "$host" != "github.com" ]]; then
    exit 0
fi

# Check if we have a token
if [ -z "$GITHUB_TOKEN" ]; then
    echo "error: GITHUB_TOKEN environment variable not set" >&2
    exit 1
fi

# Output credentials in git credential format
# x-access-token is the special username for GitHub App tokens
echo "protocol=https"
echo "host=github.com"
echo "username=x-access-token"
echo "password=$GITHUB_TOKEN"
