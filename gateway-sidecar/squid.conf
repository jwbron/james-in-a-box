# Squid proxy configuration for Phase 2 network lockdown
#
# This configuration implements SNI-based domain filtering without MITM decryption.
# The proxy reads the Server Name Indication (SNI) from TLS ClientHello to determine
# the destination hostname, then either allows (splice) or blocks (terminate) the
# connection based on the allowlist.
#
# Key security properties:
# - No traffic decryption (privacy preserved)
# - Hostname validation via SNI
# - Direct IP connections blocked
# - All blocked requests logged for audit
#
# Reference: ADR-Internet-Tool-Access-Lockdown.md Phase 2

# ==============================================================================
# Port Configuration
# ==============================================================================

# HTTP/HTTPS proxy port with SSL bump for SNI inspection
# The certificate is used for peek/splice operations, NOT for MITM
http_port 3128 ssl-bump \
    cert=/etc/squid/squid-ca.pem \
    generate-host-certificates=on \
    dynamic_cert_mem_cache_size=4MB

# ==============================================================================
# Access Control Lists
# ==============================================================================

# Define local network (jib-isolated subnet)
acl localnet src 172.30.0.0/24

# Load allowed domains from external file
# This allows easy updates without modifying this config
acl allowed_domains dstdomain "/etc/squid/allowed_domains.txt"

# Block direct IP connections (bypass attempts)
# This prevents connections to IP addresses instead of hostnames
acl direct_ip url_regex ^https?://[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+

# CONNECT method (used for HTTPS tunneling)
acl CONNECT method CONNECT

# ==============================================================================
# SSL Bump Rules (SNI Inspection)
# ==============================================================================

# Step 1: Peek at the TLS ClientHello to read SNI
acl step1 at_step SslBump1

# Peek at SNI, then decide: splice for allowed domains, terminate for others
ssl_bump peek step1
ssl_bump splice allowed_domains
ssl_bump terminate all

# ==============================================================================
# HTTP Access Rules
# ==============================================================================

# Block direct IP connections (security: prevent SNI bypass)
http_access deny direct_ip

# Allow CONNECT to allowed domains (HTTPS tunneling)
http_access allow CONNECT localnet allowed_domains

# Allow HTTP to allowed domains
http_access allow localnet allowed_domains

# Deny everything else
http_access deny all

# ==============================================================================
# Logging Configuration
# ==============================================================================

# Structured logging for audit purposes
# Format: timestamp duration client_ip status_code bytes method url hierarchy_code mime_type
logformat squid_json {"timestamp":"%{%Y-%m-%dT%H:%M:%S}tl.%03tu","duration_ms":%tr,"client_ip":"%>a","status":%>Hs,"bytes":%<st,"method":"%rm","url":"%ru","hierarchy":"%Sh","mime_type":"%mt"}

# Log to stdout for Docker log collection
access_log stdio:/proc/self/fd/1 squid_json

# Also log to file for persistence
access_log /var/log/squid/access.log squid_json

# Cache manager access log
cache_log /var/log/squid/cache.log

# ==============================================================================
# Performance & Behavior
# ==============================================================================

# Disable caching (we're a filtering proxy, not a caching proxy)
cache deny all

# Connection timeouts
connect_timeout 30 seconds
read_timeout 60 seconds
request_timeout 60 seconds

# Graceful shutdown timeout
shutdown_lifetime 5 seconds

# DNS settings (use system resolver)
dns_nameservers 8.8.8.8 8.8.4.4

# Disable ICP (Inter-Cache Protocol) - not needed
icp_port 0

# Limit maximum request size (prevent abuse)
request_body_max_size 100 MB

# Visible hostname for error pages
visible_hostname jib-gateway-proxy

# ==============================================================================
# Error Pages
# ==============================================================================

# Custom error message for blocked domains
# This helps Claude understand what's blocked and why
deny_info ERR_ACCESS_DENIED all

# ==============================================================================
# Security Hardening
# ==============================================================================

# Don't forward internal headers
via off
forwarded_for delete

# Disable potentially dangerous features
httpd_suppress_version_string on
