# Squid proxy configuration for Phase 2 network lockdown
#
# This configuration implements SNI-based domain filtering with selective SSL bump.
# The proxy reads the Server Name Indication (SNI) from TLS ClientHello to determine
# the destination hostname, then either:
# - BUMPS api.anthropic.com for credential injection (MITM)
# - SPLICES other allowed domains (no MITM, privacy preserved)
# - TERMINATES non-allowed domains
#
# Key security properties:
# - api.anthropic.com: SSL bump for credential header injection
# - Other domains: No traffic decryption (privacy preserved)
# - Hostname validation via SNI
# - Direct IP connections blocked
# - All blocked requests logged for audit
#
# Reference: ADR-Internet-Tool-Access-Lockdown.md Phase 2
# Reference: Gateway Credential Injection Proposal (PR #695)

# ==============================================================================
# Port Configuration
# ==============================================================================

# HTTP/HTTPS proxy port with SSL bump for SNI inspection and credential injection
# The CA certificate is used for:
# - Peek/splice operations for most domains (no MITM)
# - Full SSL bump for api.anthropic.com (MITM for credential header injection)
#
# generate-host-certificates=on: Required for MITM on api.anthropic.com
# tls-dh: DH parameters for forward secrecy
http_port 3128 ssl-bump \
    cert=/etc/squid/certs/gateway-ca.pem \
    key=/etc/squid/certs/gateway-ca.key \
    generate-host-certificates=on \
    dynamic_cert_mem_cache_size=16MB \
    tls-dh=prime256v1:/etc/squid/certs/dhparam.pem

# SSL certificate database for dynamically generated certificates
# Required when generate-host-certificates=on
sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/squid/ssl_db -M 16MB

# ==============================================================================
# Access Control Lists
# ==============================================================================

# Define local network (jib-isolated subnet)
acl localnet src 172.30.0.0/24

# Load allowed domains from external file
# This allows easy updates without modifying this config
acl allowed_domains dstdomain "/etc/squid/allowed_domains.txt"

# Anthropic API domain for SSL bump (credential injection)
# This domain gets full MITM treatment to inject authentication headers
acl anthropic_api ssl::server_name api.anthropic.com
acl anthropic_api_dst dstdomain api.anthropic.com

# Block direct IP connections (bypass attempts)
# This prevents connections to IP addresses instead of hostnames.
# Multiple formats must be blocked to prevent bypass attacks:
# - Standard IPv4 decimal: 192.168.1.1
# - IPv6 in brackets: [2607:f8b0:4004:800::200e]
# - Octal notation: 0177.0.0.1 (equals 127.0.0.1)
# - Hexadecimal notation: 0x7f.0x00.0x00.0x01
# - Integer notation: 2130706433 (9-10 digit number)
acl direct_ipv4 url_regex ^https?://[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+
acl direct_ipv6 url_regex ^https?://\[
acl direct_ip_octal url_regex ^https?://0[0-7]+\.
acl direct_ip_hex url_regex ^https?://0x[0-9a-fA-F]+
acl direct_ip_int url_regex ^https?://[0-9]{9,10}(/|$|:)

# CONNECT method (used for HTTPS tunneling)
acl CONNECT method CONNECT

# ==============================================================================
# SSL Bump Rules (SNI Inspection + Selective MITM)
# ==============================================================================

# Step 1: Peek at the TLS ClientHello to read SNI
acl step1 at_step SslBump1

# SSL bump decision flow:
# 1. Peek at SNI first (all connections)
# 2. Bump api.anthropic.com for credential injection (full MITM)
# 3. Splice other allowed domains (pass-through, no MITM)
# 4. Terminate non-allowed domains (block)
ssl_bump peek step1
ssl_bump bump anthropic_api
ssl_bump splice allowed_domains
ssl_bump terminate all

# ==============================================================================
# HTTP Access Rules
# ==============================================================================

# Block direct IP connections (security: prevent SNI bypass)
# All IP address formats are blocked to prevent circumvention
http_access deny direct_ipv4
http_access deny direct_ipv6
http_access deny direct_ip_octal
http_access deny direct_ip_hex
http_access deny direct_ip_int

# Allow CONNECT to allowed domains (HTTPS tunneling)
http_access allow CONNECT localnet allowed_domains

# Allow HTTP to allowed domains
http_access allow localnet allowed_domains

# Deny everything else
http_access deny all

# ==============================================================================
# Logging Configuration
# ==============================================================================

# Structured logging for audit purposes
# Format: timestamp duration client_ip status_code bytes method url hierarchy_code mime_type
logformat squid_json {"timestamp":"%{%Y-%m-%dT%H:%M:%S}tl.%03tu","duration_ms":%tr,"client_ip":"%>a","status":%>Hs,"bytes":%<st,"method":"%rm","url":"%ru","hierarchy":"%Sh","mime_type":"%mt"}

# Log to stdout for Docker log collection
access_log stdio:/proc/self/fd/1 squid_json

# Also log to file for persistence
access_log /var/log/squid/access.log squid_json

# Cache manager access log
cache_log /var/log/squid/cache.log

# ==============================================================================
# Performance & Behavior
# ==============================================================================

# Disable caching (we're a filtering proxy, not a caching proxy)
cache deny all

# Connection timeouts
connect_timeout 30 seconds
read_timeout 60 seconds
request_timeout 60 seconds

# Graceful shutdown timeout
shutdown_lifetime 5 seconds

# DNS settings - use Docker's embedded DNS resolver
# This avoids leaking DNS queries to external services and ensures
# consistent resolution within the Docker network topology
dns_nameservers 127.0.0.11

# Disable ICP (Inter-Cache Protocol) - not needed
icp_port 0

# Workaround for Asahi Linux 16KB page size crash
# Without this, Squid fails with: "xcalloc: Unable to allocate 1073741816 blocks"
# See: https://bugs.launchpad.net/ubuntu-docker-images/+bug/1978272
max_filedescriptors 1024

# Limit maximum request size (prevent abuse)
request_body_max_size 100 MB

# Visible hostname for error pages
visible_hostname jib-gateway-proxy

# ==============================================================================
# Error Pages
# ==============================================================================

# Custom error message for blocked domains
# This helps Claude understand what's blocked and why
deny_info ERR_ACCESS_DENIED all

# ==============================================================================
# Security Hardening
# ==============================================================================

# Don't forward internal headers
via off
forwarded_for delete

# Disable potentially dangerous features
httpd_suppress_version_string on
