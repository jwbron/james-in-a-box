# Squid proxy configuration for "Allow All Network" mode
#
# This configuration allows all domain access while still routing traffic
# through the proxy for audit logging.
#
# SECURITY INVARIANT:
# When ALLOW_ALL_NETWORK is enabled, PRIVATE_REPO_MODE is forced to false
# by entrypoint.sh. This ensures: open network = public repos only.
# Repository access control is enforced at the gateway API layer, which
# restricts all git/gh operations to public repositories only.
#
# Key properties:
# - All domains are allowed through the proxy
# - Direct IP connections are still blocked (security)
# - All traffic is logged for audit
# - Repository access control handled by gateway API (PRIVATE_REPO_MODE=false)
#
# Reference: ADR-Internet-Tool-Access-Lockdown.md

# ==============================================================================
# Port Configuration
# ==============================================================================

# HTTP/HTTPS proxy port with SSL bump for SNI inspection
# The certificate is used for peek/splice operations, NOT for MITM
# Note: generate-host-certificates=off because we only peek/splice (no MITM)
# This avoids needing to initialize the ssl_db certificate database
http_port 3128 ssl-bump \
    cert=/etc/squid/squid-ca.pem \
    generate-host-certificates=off \
    dynamic_cert_mem_cache_size=4MB

# ==============================================================================
# Access Control Lists
# ==============================================================================

# Define local network (jib-isolated subnet)
acl localnet src 172.30.0.0/24

# Block direct IP connections (bypass attempts)
# This prevents connections to IP addresses instead of hostnames.
# Multiple formats must be blocked to prevent bypass attacks:
# - Standard IPv4 decimal: 192.168.1.1
# - IPv6 in brackets: [2607:f8b0:4004:800::200e]
# - Octal notation: 0177.0.0.1 (equals 127.0.0.1)
# - Hexadecimal notation: 0x7f.0x00.0x00.0x01
# - Integer notation: 2130706433 (9-10 digit number)
acl direct_ipv4 url_regex ^https?://[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+
acl direct_ipv6 url_regex ^https?://\[
acl direct_ip_octal url_regex ^https?://0[0-7]+\.
acl direct_ip_hex url_regex ^https?://0x[0-9a-fA-F]+
acl direct_ip_int url_regex ^https?://[0-9]{9,10}(/|$|:)

# CONNECT method (used for HTTPS tunneling)
acl CONNECT method CONNECT

# ==============================================================================
# SSL Bump Rules (SNI Inspection)
# ==============================================================================

# Step 1: Peek at the TLS ClientHello to read SNI
acl step1 at_step SslBump1

# Peek at SNI, then splice all connections (allow all domains)
# In allow-all mode, we splice everything for maximum compatibility
ssl_bump peek step1
ssl_bump splice all

# ==============================================================================
# HTTP Access Rules
# ==============================================================================

# Block direct IP connections (security: prevent SNI bypass)
# All IP address formats are blocked to prevent circumvention
http_access deny direct_ipv4
http_access deny direct_ipv6
http_access deny direct_ip_octal
http_access deny direct_ip_hex
http_access deny direct_ip_int

# Allow CONNECT from local network (HTTPS tunneling to any domain)
http_access allow CONNECT localnet

# Allow HTTP from local network (to any domain)
http_access allow localnet

# Deny everything else
http_access deny all

# ==============================================================================
# Logging Configuration
# ==============================================================================

# Structured logging for audit purposes
# Format: timestamp duration client_ip status_code bytes method url hierarchy_code mime_type
logformat squid_json {"timestamp":"%{%Y-%m-%dT%H:%M:%S}tl.%03tu","duration_ms":%tr,"client_ip":"%>a","status":%>Hs,"bytes":%<st,"method":"%rm","url":"%ru","hierarchy":"%Sh","mime_type":"%mt"}

# Log to stdout for Docker log collection
access_log stdio:/proc/self/fd/1 squid_json

# Also log to file for persistence
access_log /var/log/squid/access.log squid_json

# Cache manager access log
cache_log /var/log/squid/cache.log

# ==============================================================================
# Performance & Behavior
# ==============================================================================

# Disable caching (we're a filtering proxy, not a caching proxy)
cache deny all

# Connection timeouts
connect_timeout 30 seconds
read_timeout 60 seconds
request_timeout 60 seconds

# Graceful shutdown timeout
shutdown_lifetime 5 seconds

# DNS settings - use Docker's embedded DNS resolver
# This avoids leaking DNS queries to external services and ensures
# consistent resolution within the Docker network topology
dns_nameservers 127.0.0.11

# Disable ICP (Inter-Cache Protocol) - not needed
icp_port 0

# Workaround for Asahi Linux 16KB page size crash
# Without this, Squid fails with: "xcalloc: Unable to allocate 1073741816 blocks"
# See: https://bugs.launchpad.net/ubuntu-docker-images/+bug/1978272
max_filedescriptors 1024

# Limit maximum request size (prevent abuse)
request_body_max_size 100 MB

# Visible hostname for error pages
visible_hostname jib-gateway-proxy

# ==============================================================================
# Error Pages
# ==============================================================================

# Custom error message for blocked requests (IP addresses only in this mode)
deny_info ERR_ACCESS_DENIED all

# ==============================================================================
# Security Hardening
# ==============================================================================

# Don't forward internal headers
via off
forwarded_for delete

# Disable potentially dangerous features
httpd_suppress_version_string on
