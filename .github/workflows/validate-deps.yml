name: Validate Dependencies

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# For auto-fix commits to work, the workflow needs write permissions
permissions:
  contents: write
  pull-requests: write

jobs:
  validate:
    name: Validate Python Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # Checkout the PR branch directly (not the merge commit)
          ref: ${{ github.head_ref }}
          # Need full history for commits
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        run: pip install uv

      - name: Validate requirements.txt syntax
        run: |
          if [ -f requirements.txt ]; then
            echo "Checking requirements.txt syntax..."
            python -c "
          import re
          with open('requirements.txt') as f:
              for i, line in enumerate(f, 1):
                  line = line.strip()
                  if line and not line.startswith('#'):
                      # Basic validation: should be a valid package spec
                      if not re.match(r'^[a-zA-Z0-9_-]+', line):
                          print(f'Line {i}: Invalid package spec: {line}')
                          exit(1)
          print('requirements.txt syntax is valid')
          "
          else
            echo "No requirements.txt found, skipping"
          fi

      - name: Validate pyproject.toml TOML syntax
        run: |
          if [ -f pyproject.toml ]; then
            echo "Checking pyproject.toml TOML syntax..."
            python -c "
          import tomllib
          with open('pyproject.toml', 'rb') as f:
              tomllib.load(f)
          print('pyproject.toml TOML syntax is valid')
          "
          else
            echo "No pyproject.toml found, skipping"
          fi

      - name: Check dependency resolution with uv
        run: |
          if [ -f pyproject.toml ]; then
            echo "Checking dependency resolution..."
            uv pip compile pyproject.toml --quiet || {
              echo "Warning: uv pip compile failed, but this may be expected for some projects"
              exit 0
            }
            echo "Dependencies resolve successfully"
          else
            echo "No pyproject.toml found, skipping dependency resolution check"
          fi

      - name: Verify host-services uv.lock is up-to-date
        id: check-lock
        continue-on-error: true
        run: |
          if [ -f host-services/pyproject.toml ] && [ -f host-services/uv.lock ]; then
            echo "Checking host-services uv.lock is up-to-date..."
            cd host-services
            # Run uv lock to regenerate the lockfile
            uv lock
            # Check if there are any changes
            if git diff --exit-code uv.lock; then
              echo "host-services/uv.lock is up-to-date"
              echo "needs_fix=false" >> $GITHUB_OUTPUT
            else
              echo "host-services/uv.lock is out of date!"
              echo "needs_fix=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "No host-services/pyproject.toml or uv.lock found, skipping"
            echo "needs_fix=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push updated uv.lock
        if: steps.check-lock.outputs.needs_fix == 'true' && github.event_name == 'pull_request'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "fix: regenerate host-services/uv.lock"
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          file_pattern: "host-services/uv.lock"

      - name: Fail if not a PR (push to main)
        if: steps.check-lock.outputs.needs_fix == 'true' && github.event_name != 'pull_request'
        run: |
          echo "host-services/uv.lock is out of date on main branch!"
          echo ""
          echo "Please run the following locally and commit the changes:"
          echo ""
          echo "  cd host-services && uv lock"
          echo ""
          exit 1
