name: Lint

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# For auto-fix commits to work, the workflow needs write permissions
permissions:
  contents: write
  pull-requests: write

jobs:
  ruff:
    name: Ruff (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # Checkout the PR branch directly (not the merge commit)
          ref: ${{ github.head_ref }}
          # Need full history for commits
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff check
        id: ruff-check
        continue-on-error: true
        run: ruff check .

      - name: Run ruff format check
        id: ruff-format
        continue-on-error: true
        run: ruff format --check .

      - name: Auto-fix with ruff
        if: (steps.ruff-check.outcome == 'failure' || steps.ruff-format.outcome == 'failure') && github.event_name == 'pull_request'
        run: |
          echo "Running ruff auto-fix..."
          ruff check --fix --unsafe-fixes . || true
          ruff format .
          echo "Auto-fix complete"

      - name: Commit and push fixes
        if: (steps.ruff-check.outcome == 'failure' || steps.ruff-format.outcome == 'failure') && github.event_name == 'pull_request'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "fix: auto-fix Python linting issues (ruff)"
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

      - name: Fail if issues remain
        if: steps.ruff-check.outcome == 'failure' || steps.ruff-format.outcome == 'failure'
        run: |
          echo "Re-checking after auto-fix..."
          ruff check .
          ruff format --check .

  bashate:
    name: Bashate (Shell)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install bashate
        run: pip install bashate

      - name: Find and lint shell scripts
        run: |
          # Find all .sh files and run bashate
          # Ignoring: E003 (indent not multiple of 4), E006 (long lines), E042 (local hides errors)
          find . -name "*.sh" -type f ! -path "./.git/*" -print0 | \
            xargs -0 -r bashate -i E003,E006,E042

  host-services-checks:
    name: Host Services Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run host-services checks
        run: |
          python3 scripts/check-claude-imports.py && \
          python3 scripts/check-gh-cli-usage.py
