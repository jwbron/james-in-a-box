name: Lint

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# For auto-fix commits to work, the workflow needs write permissions
permissions:
  contents: write
  pull-requests: write

jobs:
  ruff:
    name: Ruff (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # Checkout the PR branch directly (not the merge commit)
          ref: ${{ github.head_ref }}
          # Need full history for commits
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff check
        id: ruff-check
        continue-on-error: true
        run: ./scripts/lint-python.sh --check-only

      - name: Auto-fix with ruff
        if: steps.ruff-check.outcome == 'failure' && github.event_name == 'pull_request'
        run: ./scripts/lint-python.sh --fix

      - name: Commit and push fixes
        if: steps.ruff-check.outcome == 'failure' && github.event_name == 'pull_request'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "fix: auto-fix Python linting issues (ruff)"
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

      - name: Fail if issues remain
        if: steps.ruff-check.outcome == 'failure'
        run: ./scripts/lint-python.sh --check-only

  bashate:
    name: Bashate (Shell)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install bashate
        run: pip install bashate

      - name: Find and lint shell scripts
        run: ./scripts/lint-shell.sh
