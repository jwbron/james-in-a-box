name: Check Generated Indexes

on:
  push:
    branches: [main]
    paths:
      # Trigger when Python files change (could affect generated indexes)
      - '**/*.py'
      # Trigger when the generator itself changes
      - 'host-services/analysis/index-generator/**'
      # Trigger when requirements change (affects dependencies.json)
      - '**/requirements*.txt'
      - '**/pyproject.toml'
  pull_request:
    branches: [main]
    paths:
      - '**/*.py'
      - 'host-services/analysis/index-generator/**'
      - '**/requirements*.txt'
      - '**/pyproject.toml'

# For auto-fix commits to work, the workflow needs write permissions
permissions:
  contents: write
  pull-requests: write

jobs:
  check-indexes:
    name: Verify Generated Indexes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # Checkout the PR branch directly (not the merge commit)
          ref: ${{ github.head_ref }}
          # Need full history for commits
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Regenerate indexes
        run: |
          echo "Running index generator..."
          python3 host-services/analysis/index-generator/index-generator.py --project . --output docs/generated
          echo "Index generation complete"

      - name: Check for differences
        id: check-diff
        continue-on-error: true
        run: |
          echo "Checking if generated files are up to date..."

          # Check if any generated files have changed (ignoring timestamp line)
          # The -I option ignores lines matching the regex pattern
          if git diff --exit-code -I '"generated":' docs/generated/; then
            echo "✅ Generated indexes are up to date"
            echo "needs_fix=false" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "❌ Generated indexes are out of date!"
            echo ""
            echo "The following files need to be regenerated:"
            git diff --name-only docs/generated/
            echo "needs_fix=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push regenerated indexes
        if: steps.check-diff.outputs.needs_fix == 'true' && github.event_name == 'pull_request'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "fix: regenerate documentation indexes"
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          file_pattern: "docs/generated/*"

      - name: Fail if not a PR (push to main)
        if: steps.check-diff.outputs.needs_fix == 'true' && github.event_name != 'pull_request'
        run: |
          echo "❌ Generated indexes are out of date on main branch!"
          echo ""
          echo "To fix this, run:"
          echo "  python3 host-services/analysis/index-generator/index-generator.py"
          echo ""
          echo "Then commit the updated files."
          exit 1

      - name: Show index summary (on success)
        if: success()
        run: |
          echo "=== Generated Index Summary ==="
          python3 host-services/analysis/index-generator/query-index.py --indexes docs/generated summary || true
