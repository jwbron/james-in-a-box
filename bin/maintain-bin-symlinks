#!/usr/bin/env bash
#
# maintain-bin-symlinks - Automatically maintain bin/ directory symlinks
#
# This script ensures all user-facing commands are properly symlinked in bin/.
# Run periodically or after adding new commands to keep bin/ up to date.
#
# Usage: maintain-bin-symlinks [--dry-run] [--verbose] [--check]
#

set -euo pipefail

# Get the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BIN_DIR="$SCRIPT_DIR"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# Options
DRY_RUN=false
VERBOSE=false
CHECK_MODE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --dry-run|-n)
            DRY_RUN=true
            shift
            ;;
        --verbose|-v)
            VERBOSE=true
            shift
            ;;
        --check|-c)
            CHECK_MODE=true
            DRY_RUN=true  # Check mode implies dry-run
            shift
            ;;
        --help|-h)
            echo "Usage: maintain-bin-symlinks [--dry-run] [--verbose] [--check]"
            echo ""
            echo "Automatically maintain bin/ directory symlinks."
            echo ""
            echo "Options:"
            echo "  --dry-run, -n   Show what would be done without making changes"
            echo "  --verbose, -v   Show all symlinks, not just changes"
            echo "  --check, -c     Check mode: exit non-zero if changes needed (for CI)"
            echo "  --help, -h      Show this help message"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Define all symlinks: name -> relative target path
# Format: "symlink_name:relative_path_from_bin"
#
# Categories:
# - Container launcher and setup
# - Analysis tools (user-facing commands)
# - Setup scripts (for installing services)
# - Utilities (logs, maintenance)
#
declare -a SYMLINKS=(
    # Container launcher and setup
    "jib:../jib-container/jib"
    "docker-setup.py:../jib-container/docker-setup.py"

    # Container tools - commands available inside the container (exposed for host use too)
    "discover-tests:../jib-container/jib-tools/discover-tests.py"

    # Analysis tools - user-facing commands for humans
    "adr-researcher:../host-services/analysis/adr-researcher/adr-researcher.py"
    "analyze-pr:../host-services/analysis/analyze-pr/analyze-pr"
    "beads-analyzer:../host-services/analysis/beads-analyzer/beads-analyzer.py"
    "check-doc-drift:../host-services/analysis/doc-generator/drift-detector.py"
    "feature-analyzer:../host-services/analysis/feature-analyzer/feature-analyzer.py"
    "fix-doc-links:../scripts/fix-doc-links.py"
    "generate-docs:../host-services/analysis/doc-generator/doc-generator.py"
    "inefficiency-report:../host-services/analysis/inefficiency-detector/weekly_report_generator.py"
    "query-index:../host-services/analysis/index-generator/query-index.py"
    "spec-enricher:../host-services/analysis/spec-enricher/spec-enricher.py"

    # Repository onboarding tools
    "jib-internal-devtools-setup:../host-services/analysis/repo-onboarding/jib-internal-devtools-setup"
    "jib-regenerate-indexes:../host-services/analysis/repo-onboarding/jib-regenerate-indexes"

    # Setup scripts for installing services
    "setup-beads-analyzer:../host-services/analysis/beads-analyzer/setup.sh"
    "setup-doc-generator:../host-services/analysis/doc-generator/setup.sh"
    "setup-feature-analyzer:../host-services/analysis/feature-analyzer/setup.sh"
    "setup-inefficiency-detector:../host-services/analysis/inefficiency-detector/setup.sh"
    "setup-slack-notifier:../host-services/slack/slack-notifier/setup.sh"
    "setup-slack-receiver:../host-services/slack/slack-receiver/setup.sh"
    "setup-spec-enricher:../host-services/analysis/spec-enricher/setup.sh"
    "setup-trace-collector:../host-services/analysis/trace-collector/setup.sh"
    "setup-repo-onboarding:../host-services/analysis/repo-onboarding/setup.sh"
    "setup-github-token-refresher:../host-services/utilities/github-token-refresher/setup.sh"
    "setup-worktree-watcher:../host-services/utilities/worktree-watcher/setup.sh"

    # Utilities
    "jib-logs:../host-services/utilities/jib-logs/jib-logs"
    "maintain-bin-symlinks:maintain-bin-symlinks"  # Self-reference (no-op but for documentation)
)

# Track statistics
created=0
removed=0
skipped=0
errors=0

log_info() {
    if [[ "$VERBOSE" == true ]]; then
        echo -e "${GREEN}[OK]${NC} $1"
    fi
}

log_create() {
    echo -e "${GREEN}[CREATE]${NC} $1"
}

log_remove() {
    echo -e "${YELLOW}[REMOVE]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_skip() {
    if [[ "$VERBOSE" == true ]]; then
        echo -e "${YELLOW}[SKIP]${NC} $1"
    fi
}

# Create symlinks
for entry in "${SYMLINKS[@]}"; do
    name="${entry%%:*}"
    target="${entry#*:}"

    # Skip self-reference
    if [[ "$name" == "maintain-bin-symlinks" ]]; then
        continue
    fi

    link_path="$BIN_DIR/$name"
    target_full="$BIN_DIR/$target"

    # Check if target exists
    if [[ ! -e "$target_full" ]]; then
        log_error "$name -> $target (target does not exist)"
        : $((errors++))
        continue
    fi

    # Check if symlink already exists and is correct
    if [[ -L "$link_path" ]]; then
        current_target=$(readlink "$link_path")
        if [[ "$current_target" == "$target" ]]; then
            log_info "$name -> $target"
            : $((skipped++))
            continue
        else
            # Wrong target, remove and recreate
            log_remove "$name (was -> $current_target)"
            if [[ "$DRY_RUN" == false ]]; then
                rm "$link_path"
            fi
            : $((removed++))
        fi
    elif [[ -e "$link_path" ]]; then
        # Regular file exists, error
        log_error "$name exists but is not a symlink"
        : $((errors++))
        continue
    fi

    # Create symlink
    log_create "$name -> $target"
    if [[ "$DRY_RUN" == false ]]; then
        ln -s "$target" "$link_path"
    fi
    : $((created++))
done

# Find and report broken symlinks not in our list
echo ""
echo "Checking for broken or unknown symlinks..."
for link in "$BIN_DIR"/*; do
    if [[ -L "$link" && ! -e "$link" ]]; then
        name=$(basename "$link")
        target=$(readlink "$link")
        log_remove "$name -> $target (broken symlink)"
        if [[ "$DRY_RUN" == false ]]; then
            rm "$link"
        fi
        : $((removed++))
    fi
done

# Summary
echo ""
echo "Summary:"
echo "  Created: $created"
echo "  Removed: $removed"
echo "  Unchanged: $skipped"
if [[ $errors -gt 0 ]]; then
    echo -e "  ${RED}Errors: $errors${NC}"
fi

if [[ "$DRY_RUN" == true ]]; then
    echo ""
    echo "(Dry run - no changes made)"
fi

# In check mode, exit non-zero if any changes would be needed
if [[ "$CHECK_MODE" == true ]]; then
    if [[ $created -gt 0 || $removed -gt 0 || $errors -gt 0 ]]; then
        echo ""
        echo -e "${RED}Check failed: bin/ symlinks need maintenance${NC}"
        echo "Run './bin/maintain-bin-symlinks' to fix."
        exit 1
    else
        echo ""
        echo -e "${GREEN}Check passed: all symlinks are up to date${NC}"
    fi
fi

exit 0
